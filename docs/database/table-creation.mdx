---
sidebar_position: 2
description: ğŸ“Œ ìƒì„±ëœ DB ì— query ë¥¼ ì‘ì„±í•˜ì—¬ í…Œì´ë¸”ì„ ìƒì„±í•©ë‹ˆë‹¤.
---

# 2) Table Creation
import CodeDescription from '@site/src/components/CodeDescription';
import BrowserWindow from '@site/src/components/BrowserWindow';
import { Chapter, Part } from '@site/src/components/Highlight';

### ëª©í‘œ

1. ìƒì„±ëœ DB ì— query ë¥¼ ì‘ì„±í•˜ì—¬ í…Œì´ë¸”ì„ ìƒì„±í•©ë‹ˆë‹¤.
2. ìƒì„±ëœ í…Œì´ë¸” ì„ í™•ì¸í•©ë‹ˆë‹¤.

<details>
<summary>ìŠ¤í™ ëª…ì„¸ì„œ</summary>
<CodeDescription>

### ìŠ¤í™ ëª…ì„¸ì„œ

1. `pandas`, `psycopg2-binary`, `scikit-learn` íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.
2. Python ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì´ìš©í•˜ì—¬ DB ì— ì ‘ê·¼í•©ë‹ˆë‹¤.
    - user : `myuser`
    - password : `mypassword`
    - host : `localhost`
    - port : `5432`
    - database : `mydatabase`
3. Python ì—ì„œ `psycopg2` ë¥¼ ì‚¬ìš©í•˜ì—¬  `iris_data` í…Œì´ë¸”ì„ ìƒì„±í•©ë‹ˆë‹¤.
    - í…Œì´ë¸”ì€ ë‹¤ìŒê³¼ ê°™ì€ column ë“¤ì„ ê°–ê³  ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
        
        
        | column | id | sepal length (cm) | sepal width (cm) | petal length (cm) | petal width (cm) | target |
        | --- | --- | --- | --- | --- | --- | --- |
        | type | primary key | float | float | float | float | int |
4. `psql` ì„ ì´ìš©í•˜ì—¬ ìƒì„±í•œ í…Œì´ë¸”ì„ í™•ì¸í•©ë‹ˆë‹¤.

</CodeDescription>
</details>

---

<BrowserWindow url="https://github.com/mlops-for-mle/mlops-for-mle/tree/main/ch1">

í•´ë‹¹ íŒŒíŠ¸ì˜ ì „ì²´ ì½”ë“œëŠ” [mlops-for-mle/ch1/](https://github.com/mlops-for-mle/mlops-for-mle/tree/main/ch1) ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```js
ch1
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ Makefile
// highlight-next-line
â”œâ”€â”€ create_table.py
â”œâ”€â”€ data_generator.py
â”œâ”€â”€ docker-compose.yaml
â”œâ”€â”€ insert_data.py
â””â”€â”€ insert_data_loop.py
```

</BrowserWindow>


## 0. íŒ¨í‚¤ì§€ ì„¤ì¹˜

í•„ìš”í•œ íŒ¨í‚¤ì§€ë“¤ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.

```bash
# terminal-command
pip install pandas psycopg2-binary scikit-learn
```

## 1. í…Œì´ë¸” ìƒì„±
Python ì—ì„œ postgres ì„œë²„ì— ì ‘ê·¼í•˜ê¸° ìœ„í•œ ê°€ì¥ ê°„ë‹¨í•œ ë°©ë²•ì€ `psycopg2` íŒ¨í‚¤ì§€ë¥¼ ì´ìš©í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.  
`psycopg2` ì— ê´€í•œ ìì„¸í•œ ë‚´ìš©ì€ [ê³µì‹ ë¬¸ì„œ](https://www.psycopg.org/docs/)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.

### 1.1 DB connection
`psycopg2` ë¥¼ ì´ìš©í•˜ì—¬ DB ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ì„œëŠ” `connect` í•¨ìˆ˜ë¥¼ ì´ìš©í•´ì•¼ í•©ë‹ˆë‹¤. `connect` í•¨ìˆ˜ë¥¼ ì•„ë˜ì™€ ê°™ì´ ì‘ì„±í•˜ì—¬ `db_connect` connector ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

```python
import psycopg2

db_connect = psycopg2.connect(
    user="myuser", 
    password="mypassword",
    host="localhost",
    port=5432,
    database="mydatabase",
)
```

ì—¬ê¸°ì„œ ê¸°ì–µí•´ì•¼í•  ê²ƒì€ ì¼ë°˜ì ìœ¼ë¡œ DB ì—°ê²° ì‹œ `user`, `password`, `host`, `port`, `database` ì´ 5ê°€ì§€ì˜ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.
<Chapter>1) DB Server Creation</Chapter> ì±•í„°ì—ì„œ DB ë¥¼ ìƒì„±í•  ë•Œ ì…ë ¥í•œ `myuser`, `mypassword`, `localhost`, `5432`, `mydatabase` ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.

### 1.2 Table creation query

#### 1.2.1 SQL Table Creation Query Rule

í…Œì´ë¸”ì„ ìƒì„±í•˜ê¸° ìœ„í•œ SQL ë¬¸ì€ ì•„ë˜ì™€ ê°™ì€ ê·œì¹™ì„ ê°–ìŠµë‹ˆë‹¤.

```sql
CREATE TABLE table_name (
    column1 datatype,
    column2 datatype,
    column3 datatype,
   ....
);
```

ì´ì œ ìœ„ì—ì„œ ì •ì˜í•œ ìŠ¤í™ ëª…ì„¸ì„œì— ë§ì¶° í•„ìš”í•œ ë‚´ìš©ì„ ì±„ì›Œë³´ê² ìŠµë‹ˆë‹¤.

#### 1.2.2 Table Creation Query

ì‚½ì…í•  ë°ì´í„°ëŠ” `scikit-learn` íŒ¨í‚¤ì§€ì˜ `load_iris` ë¥¼ ì´ìš©í•©ë‹ˆë‹¤.

```python
import pandas as pd
from sklearn.datasets import load_iris

X, y = load_iris(return_X_y=True, as_frame=True)
df = pd.concat([X, y], axis="columns")
```

ë°ì´í„°ë¥¼ ì¶œë ¥í•˜ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

```python
print(df)
#      sepal length (cm)  sepal width (cm)  petal length (cm)  petal width (cm)  target
# 0                  5.1               3.5                1.4               0.2       0
# 1                  4.9               3.0                1.4               0.2       0
# 2                  4.7               3.2                1.3               0.2       0
# 3                  4.6               3.1                1.5               0.2       0
# 4                  5.0               3.6                1.4               0.2       0
# ..                 ...               ...                ...               ...     ...
# 145                6.7               3.0                5.2               2.3       2
# 146                6.3               2.5                5.0               1.9       2
# 147                6.5               3.0                5.2               2.0       2
# 148                6.2               3.4                5.4               2.3       2
# 149                5.9               3.0                5.1               1.8       2
#
# [150 rows x 5 columns]
```

Iris ë°ì´í„°ì˜ column ë“¤ì˜ type ì„ í™•ì¸í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```python
print(df.dtypes)
# sepal length (cm)    float64
# sepal width (cm)     float64
# petal length (cm)    float64
# petal width (cm)     float64
# target                 int64
# dtype: object
```

`X` ì˜ data type ì€ `float64` ë¡œ í‘œê¸°ë˜ê³ , target ì€ `int64` ë¡œ í‘œê¸°ë©ë‹ˆë‹¤. ê·¸ëŸ°ë° ì´ data type ë“¤ì€ postgres ì—ì„œ ì§€ì›í•˜ì§€ ì•Šê¸°ì— ê°ê° `float8`, `int` ë¡œ ì„ ì–¸í•´ ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤. 
ë˜í•œ column ì´ë¦„ì€ `sepal length (cm)` ì— í¬í•¨ë˜ì–´ ìˆëŠ” `(` ë•Œë¬¸ì— ì´ìš©í•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— í•´ë‹¹ ë¶€ë¶„ì„ ì œê±°í•´ì•¼ í•©ë‹ˆë‹¤.

ìœ„ì˜ ë‚´ìš©ì„ ë°˜ì˜í•œ query ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```python
create_table_query = """
CREATE TABLE IF NOT EXISTS iris_data (
    id SERIAL PRIMARY KEY,
    sepal_width float8,
    sepal_length float8,
    petal_width float8,
    petal_length float8,
    target int
);"""
```

#### 1.2.3 Send Query to DB

ì´ì œ ì‘ì„±í•œ query ë¥¼ DB ì— ì „ë‹¬í•´ì•¼ í•©ë‹ˆë‹¤. ì „ë‹¬ì„ ìœ„í•´ì„œëŠ” ì•„ë˜ì˜ ê³¼ì •ì„ ìˆ˜í–‰í•˜ë©´ ë©ë‹ˆë‹¤.

1. connector ì˜ cursor ë¥¼ ì—´ê³  cursor ì— query ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.
    
    ```python
    cur = db_connect.cursor()
    cur.execute(create_table_query)
    ```
    
2. ì „ë‹¬ ëœ query ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” connector ì—ì„œ `commit` ì„ í•´ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.
    
    ```python
    db_connect.commit()
    ```
    
3. cursor ì˜ ì‚¬ìš©ì´ ëë‚˜ë©´ cursor ë¥¼ `close` í•©ë‹ˆë‹¤.
    
    ```python
    cur.close()
    ```
    

ìœ„ì—ì„œ ì„¤ëª…í•œ 3ê°œì˜ ê³¼ì •ì€ ì•„ë˜ì²˜ëŸ¼ í•˜ë‚˜ì˜ í”„ë¡œì„¸ìŠ¤ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```python
with db_connect.cursor() as cur:
    cur.execute(create_table_query)
    db_connect.commit()
```

with ë¬¸ì„ ì´ìš©í•œ ì‚¬ìš©ë²•ì— ëŒ€í•œ ë‚´ìš©ì€ [ê³µì‹ í™ˆí˜ì´ì§€](https://www.psycopg.org/docs/connection.html#the-connection-class)ì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ ì–¸ê¸‰í•˜ê³  ìˆìŠµë‹ˆë‹¤.

> Connections can be used as context managers. Note that a context wraps a transaction: if the context exits with success the transaction is committed, if it exits with an exception the transaction is rolled back. Note that the connection is not closed by the context and it can be used for several contexts.

#### 1.2.4 `create_table`

ìœ„ì—ì„œ ì‘ì„±í•œ ì½”ë“œë¥¼ ì´ìš©í•´ `create_table` í•¨ìˆ˜ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

```python
def create_table(db_connect):
    create_table_query = """
    CREATE TABLE IF NOT EXISTS iris_data (
        id SERIAL PRIMARY KEY,
        sepal_length float8,
        sepal_width float8,
        petal_length float8,
        petal_width float8,
        target int
    );"""
    print(create_table_query)
    with db_connect.cursor() as cur:
        cur.execute(create_table_query)
        db_connect.commit()
```

`create_table`  ì˜ ì…ë ¥ê°’ì€ `db_connect` ì…ë‹ˆë‹¤. DBì™€ì˜ ì—°ê²°ì„ ì§€ì†ì ìœ¼ë¡œ ìš”êµ¬í•  ê²½ìš° ë¶€í•˜ê°€ ê°ˆ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ìµœì´ˆì— í•œë²ˆë§Œ ì—°ê²° í›„ ì—°ê²°ëœ connector ë¥¼ ì¬ì‚¬ìš©í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤.  
í•¨ìˆ˜ ë‚´ë¶€ì—ì„œëŠ” query ê°€ ìˆê³  ì‹¤í–‰ë  ë•Œ ì–´ë–¤ query ê°€ ì‹¤í–‰ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ì„œ `print` ë¥¼ í•©ë‹ˆë‹¤.  
ë§ˆì§€ë§‰ìœ¼ë¡œ query ë¥¼ DBì— ì „ë‹¬í•˜ëŠ” with ë¬¸ì„ ì¶”ê°€í•©ë‹ˆë‹¤.  

### 2.3 Query ì‹¤í–‰

#### 2.3.1 `create_table.py`

ìœ„ì—ì„œ ì‘ì„±í•œ ì½”ë“œë¥¼ ëª¨ì•„ì„œ `create_table.py` ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.

```python  title="create_table.py"
# create_table.py
import psycopg2

def create_table(db_connect):
    create_table_query = """
    CREATE TABLE IF NOT EXISTS iris_data (
        id SERIAL PRIMARY KEY,
        sepal_length float8,
        sepal_width float8,
        petal_length float8,
        petal_width float8,
        target int
    );"""
    print(create_table_query)
    with db_connect.cursor() as cur:
        cur.execute(create_table_query)
        db_connect.commit()

if __name__ == "__main__":
    db_connect = psycopg2.connect(
        user="myuser",
        password="mypassword",
        host="localhost",
        port=5432,
        database="mydatabase",
    )
    create_table(db_connect)
```

#### 1.3.2 ì‹¤í–‰

Python ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
# terminal-command
python create_table.py
CREATE TABLE IF NOT EXISTS iris_data (
    id SERIAL PRIMARY KEY,
    sepal_length float8,
    sepal_width float8,
    petal_length float8,
    petal_width float8,
    target int
);
```

## 2. Table í™•ì¸

`psql` ì„ ì´ìš©í•˜ì—¬ DB ì— ì ‘ê·¼í•˜ê³ , ìƒì„±ëœ í…Œì´ë¸”ì„ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.

1. ìš°ì„  psqlì— ì ‘ì†í•©ë‹ˆë‹¤.
    
    ```bash
    # terminal-command
    psql -h localhost -p 5432 -U myuser -d mydatabase
    Password for user myuser: 
    psql (14.3, server 14.0 (Debian 14.0-1.pgdg110+1))
    Type "help" for help.
    
    mydatabase=#
    ```
    
2. `\d` ë¥¼ ì…ë ¥í•´ ìƒì„±ëœ í…Œì´ë¸”ë“¤ì˜ ëª©ë¡ì„ í™•ì¸í•©ë‹ˆë‹¤.
    
    ```bash
    # terminal-command
    mydatabase=# \d
    List of relations
     Schema |       Name       |   Type   | Owner  
    --------+------------------+----------+--------
     public | iris_data        | table    | myuser
     public | iris_data_id_seq | sequence | myuser
    (2 rows)
    
    ```
    
3. ìœ„ ëª©ë¡ ì¤‘ `iris_data` í…Œì´ë¸”ì— ìˆëŠ” ë°ì´í„° ì „ì²´ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•œ query ë¬¸ì„ ì‹¤í–‰í•œ ê²°ê³¼ì…ë‹ˆë‹¤.
    
    ```bash
    # terminal-command
    mydatabase=# select * from iris_data;
     id | sepal_length | sepal_width | petal_length | petal_width | target 
    ----+--------------+-------------+--------------+-------------+--------
    (0 rows)
    ```
    
    column ë“¤ì´ ìœ„ì˜ Python ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‘ì„±í•œ ì´ë¦„ê³¼ ê°™ì€ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    ë˜í•œ ì•„ì§ ì…ë ¥í•œ ë°ì´í„°ê°€ ì—†ê¸° ë•Œë¬¸ì— `(0 rows)` ë¡œ ë‚˜ì˜¤ëŠ” ê±¸ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
