---
sidebar_position: 3
description: ğŸ“Œ ìƒì„±í•œ í…Œì´ë¸”ì— iris ë°ì´í„° í•œ ì¤„ì„ ì‚½ì…í•©ë‹ˆë‹¤.
---

# 3) Data Insertion
import CodeDescription from '@site/src/components/CodeDescription';
import BrowserWindow from '@site/src/components/BrowserWindow';
import { Chapter, Part } from '@site/src/components/Highlight';

### ëª©í‘œ

1. ìƒì„±í•œ í…Œì´ë¸”ì— iris ë°ì´í„° í•œ ì¤„ì„ ì‚½ì…í•©ë‹ˆë‹¤.
2. ì‚½ì…í•œ ë°ì´í„°ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.

<details>
<summary>ìŠ¤í™ ëª…ì„¸ì„œ</summary>
<CodeDescription>

### ìŠ¤í™ ëª…ì„¸ì„œ

1. Python ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì´ìš©í•˜ì—¬ DB ì— ì ‘ì†í•©ë‹ˆë‹¤.
    - <var>user</var> : <code>myuser</code>
    - <var>password</var> : <code>mypassword</code>
    - <var>host</var> : <code>localhost</code>
    - <var>port</var> : <code>5432</code>
    - <var>database</var> : <code>mydatabase</code>
2. `psycopg2` íŒ¨í‚¤ì§€ë¥¼ ì´ìš©í•˜ì—¬ ìƒì„±ëœ <var>`iris_data`</var> í…Œì´ë¸”ì— data row 1ê°œë¥¼ ì‚½ì…í•©ë‹ˆë‹¤.
3. `psql` ì„ ì´ìš©í•˜ì—¬ ì‚½ì…í•œ ë°ì´í„°ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.

</CodeDescription>
</details>

---

<BrowserWindow url="https://github.com/mlops-for-mle/mlops-for-mle/tree/main/ch1">

í•´ë‹¹ íŒŒíŠ¸ì˜ ì „ì²´ ì½”ë“œëŠ” [mlops-for-mle/ch1/](https://github.com/mlops-for-mle/mlops-for-mle/tree/main/ch1) ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```js
ch1
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ Makefile
â”œâ”€â”€ create_table.py
â”œâ”€â”€ data_generator.py
â”œâ”€â”€ docker-compose.yaml
// highlight-next-line
â”œâ”€â”€ insert_data.py
â””â”€â”€ insert_data_loop.py
```

</BrowserWindow>

## 1. ë°ì´í„° ì‚½ì…

### 1.1 Iris ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°

Iris ë°ì´í„° ë¥¼ ë¶ˆëŸ¬ì˜¨ ë’¤,  <Chapter>2) Table Creation</Chapter> ì±•í„°ì—ì„œ ìƒì„±ëœ í…Œì´ë¸”ì˜ column ì´ë¦„ê³¼ ì¼ì¹˜í•˜ë„ë¡ ìˆ˜ì •í•©ë‹ˆë‹¤.

```python
import pandas as pd
from sklearn.datasets import load_iris

X, y = load_iris(return_X_y=True, as_frame=True)
df = pd.concat([X, y], axis="columns")
rename_rule = {
    "sepal length (cm)": "sepal_length",
    "sepal width (cm)": "sepal_width",
    "petal length (cm)": "petal_length",
    "petal width (cm)": "petal_width",
}
df = df.rename(columns=rename_rule)
```

ë³€í™˜ëœ ë°ì´í„°ë¥¼ í™•ì¸í•˜ë©´ ì•„ë˜ê³¼ ê°™ìŠµë‹ˆë‹¤.

```python
print(df)
#        sepal_width  sepal_length  petal_width  petal_length  target
# 0            5.1           3.5          1.4           0.2       0
# 1            4.9           3.0          1.4           0.2       0
# 2            4.7           3.2          1.3           0.2       0
# 3            4.6           3.1          1.5           0.2       0
# 4            5.0           3.6          1.4           0.2       0
# ..           ...           ...          ...           ...     ...
# 145          6.7           3.0          5.2           2.3       2
# 146          6.3           2.5          5.0           1.9       2
# 147          6.5           3.0          5.2           2.0       2
# 148          6.2           3.4          5.4           2.3       2
# 149          5.9           3.0          5.1           1.8       2
#
# [150 rows x 5 columns]
```

ìœ„ì˜ ë‚´ìš©ì„ `get_data` í•¨ìˆ˜ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.

```python
def get_data():
    X, y = load_iris(return_X_y=True, as_frame=True)
    df = pd.concat([X, y], axis="columns")
    rename_rule = {
        "sepal length (cm)": "sepal_length",
        "sepal width (cm)": "sepal_width",
        "petal length (cm)": "petal_length",
        "petal width (cm)": "petal_width",
    }
    df = df.rename(columns=rename_rule)
    return df
```

### 1.2 Data Insertion Query ì‘ì„±

#### 1.2.1 SQL Data Insertion Query Rule

Data ë¥¼ ì‚½ì…í•  ìˆ˜ ìˆëŠ” query ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤. DB ì— data ë¥¼ ì‚½ì…í•˜ëŠ” query ì˜ í¬ë§·ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```sql
INSRT INTO {table_name} (col_1, col_2, ...) VALUES (val_1, val_2, ...)
```

ì´ì œ ìœ„ì—ì„œ ì •ì˜í•œ ìŠ¤í™ ëª…ì„¸ì„œì— ë§ì¶° í•„ìš”í•œ ë‚´ìš©ì„ ì±„ì›Œë³´ê² ìŠµë‹ˆë‹¤.

#### 1.2.2 Data Insertion Query

`sample` í•¨ìˆ˜ë¥¼ ì´ìš©í•˜ì—¬ data row 1ê°œë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.

```python
data = df.sample(1).squeeze()
```

ì¶”ì¶œëœ ë°ì´í„°ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```python
print(data)
# sepal_width     6.8
# sepal_length    3.0
# petal_width     5.5
# petal_length    2.1
# target          2.0
# Name: 112, dtype: float64
```

ì¶”ì¶œëœ data ë¥¼ ì´ìš©í•´ query ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

```python
insert_row_query = f"""
INSERT INTO iris_data
    (sepal_length, sepal_width, petal_length, petal_width, target)
    VALUES (
        {data.sepal_length},
        {data.sepal_width},
        {data.petal_length},
        {data.petal_width},
        {data.target}
    );"""
```

#### 1.2.3  Send Query to DB

ì‘ì„±í•œ query ë¥¼ DB ì— ì „ë‹¬í•©ë‹ˆë‹¤.

```python
with db_connect.cursor() as cur:
    cur.execute(insert_row_query)
    db_connect.commit()

```

#### 2.2.4 `insert_data` í•¨ìˆ˜ ì‘ì„±

ìœ„ì—ì„œ ì‘ì„±í•œ ì½”ë“œë¥¼ ì´ìš©í•´ `insert_data` í•¨ìˆ˜ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

```python
def insert_data(db_connect, data):
    insert_row_query = f"""
    INSERT INTO iris_data
        (sepal_length, sepal_width, petal_length, petal_width, target)
        VALUES (
            {data.sepal_length},
            {data.sepal_width},
            {data.petal_length},
            {data.petal_width},
            {data.target}
        );"""
    print(insert_row_query)
    with db_connect.cursor() as cur:
        cur.execute(insert_row_query)
        db_connect.commit()

```

### 1.3 Query ì‹¤í–‰

#### 1.3.1 `insert_data.py`

ìœ„ì—ì„œ ì‘ì„±í•œ ì½”ë“œë¥¼ ëª¨ì•„ì„œ `insert_data.py` ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.

```python title="insert_data.py"
# insert_data.py
import pandas as pd
import psycopg2
from sklearn.datasets import load_iris


def get_data():
    X, y = load_iris(return_X_y=True, as_frame=True)
    df = pd.concat([X, y], axis="columns")
    rename_rule = {
        "sepal length (cm)": "sepal_length",
        "sepal width (cm)": "sepal_width",
        "petal length (cm)": "petal_length",
        "petal width (cm)": "petal_width",
    }
    df = df.rename(columns=rename_rule)
    return df


def insert_data(db_connect, data):
    insert_row_query = f"""
    INSERT INTO iris_data
        (sepal_length, sepal_width, petal_length, petal_width, target)
        VALUES (
            {data.sepal_length},
            {data.sepal_width},
            {data.petal_length},
            {data.petal_width},
            {data.target}
        );"""
    print(insert_row_query)
    with db_connect.cursor() as cur:
        cur.execute(insert_row_query)
        db_connect.commit()


if __name__ == "__main__":
    db_connect = psycopg2.connect(
        user="myuser",
        password="mypassword",
        host="localhost",
        port=5432,
        database="mydatabase",
    )
    df = get_data()
    insert_data(db_connect, df.sample(1).squeeze())
```

#### 1.3.2 ì‹¤í–‰

ìœ„ì—ì„œ ì‘ì„±í•œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
# terminal-command
python insert_data.py
        INSERT INTO iris_data
            (sepal_length, sepal_width, petal_length, petal_width, target)
            VALUES (
                5.0,
                3.5,
                1.6,
                0.6,
                0
            );
```

## 2. Data í™•ì¸

`psql` ì„ ì´ìš©í•˜ì—¬ DB ì— ì ‘ì†í•˜ê³ , ì‚½ì…ëœ ë°ì´í„°ë¥¼ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.

1. `psql` ì„ ì´ìš©í•˜ì—¬ DB ì— ì ‘ì†í•©ë‹ˆë‹¤.
    
    ```bash
    # terminal-command
    psql -h localhost -p 5432 -U myuser -d mydatabase
    Password for user myuser: 
    psql (14.3, server 14.0 (Debian 14.0-1.pgdg110+1))
    Type "help" for help.
    
    mydatabase=#
    ```
    
2. <Chapter>2) Table Creation</Chapter> ì±•í„°ì—ì„œ ì‘ì„±í•œ <var><code>iris_data</code></var> í…Œì´ë¸”ì— ìˆëŠ” ë°ì´í„° ì „ì²´ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•œ query ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
    
    ```sql
    mydatabase=# select * from iris_data;
     id | sepal_length | sepal_width | petal_length | petal_width | target 
    ----+--------------+-------------+--------------+-------------+--------
      1 |          6.7 |           3 |            5 |         1.7 |      1
    (1 row)
    ```
    
    <Chapter>2) Table Creation</Chapter> ì±•í„°ì™€ëŠ” ë‹¤ë¥´ê²Œ ë°ì´í„°ê°€ í•œ ì¤„ ì¶”ê°€ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
