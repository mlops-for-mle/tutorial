---
sidebar_position: 6
description: ğŸ“Œ DB ì»¨í…Œì´ë„ˆì™€ data generator ì»¨í…Œì´ë„ˆë¥¼ í•¨ê»˜ ë„ìš°ê¸° ìœ„í•œ Docker Compose íŒŒì¼ì„ ì‘ì„±í•©ë‹ˆë‹¤.
---

# 6) Data Generator on Docker Compose
import CodeDescription from '@site/src/components/CodeDescription';
import PreviewDescription from '@site/src/components/PreviewDescription';
import BrowserWindow from '@site/src/components/BrowserWindow';
import { Chapter, Part } from '@site/src/components/Highlight';

<PreviewDescription>

## Chapter Preview
---

### ëª©í‘œ

1. DB ì»¨í…Œì´ë„ˆì™€ data generator ì»¨í…Œì´ë„ˆë¥¼ í•¨ê»˜ ë„ìš°ê¸° ìœ„í•œ Docker Compose íŒŒì¼ì„ ì‘ì„±í•©ë‹ˆë‹¤.
2. DB ì•ˆì— ë°ì´í„°ê°€ ê³„ì†í•´ì„œ ì‚½ì…ë˜ê³  ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.


### ìŠ¤í™ ëª…ì„¸ì„œ

1. Docker Compose íŒŒì¼ì„ ì‘ì„±í•©ë‹ˆë‹¤.

    - Postgres server service
        - Service name : `postgres-server`
        - Image : `postgres:14.0`
        - Container name : `postgres-server`
        - Environment
            - <var>POSTGRES_USER</var> : <code>myuser</code>
            - <var>POSTGRES_PASSWORD</var> : <code>mypassword</code>
            - <var>POSTGRES_DB</var> : <code>mydatabase</code>
        - Port forwarding : `5432:5432`
    - Data generator serivce
        - Service name : `data-generator`
        - Image : `Dockerfile`
        - Container name : `data-generator`
        - Command : `["postgres-server"]`

    :::info

    Postgres server ì„œë¹„ìŠ¤ì™€ data generator ì„œë¹„ìŠ¤ë¥¼ ë„ìš¸ ë•Œ ì–´ë–¤ ì„œë¹„ìŠ¤ê°€ ë¨¼ì € ë„ì›Œì ¸ì•¼ í•˜ëŠ”ì§€ ìƒê°í•´ë³´ê³ , ê·¸ ê¸°ëŠ¥ì„ Compose íŒŒì¼ì— ì¶”ê°€í•©ë‹ˆë‹¤.

    :::

2. Docker Compose íŒŒì¼ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
3. `psql` ì„ ì´ìš©í•˜ì—¬ DB ì— ë°ì´í„°ê°€ ê³„ì†í•´ì„œ ìŒ“ì´ê³  ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    - Local ì—ì„œ í™•ì¸í•©ë‹ˆë‹¤.
    - Data generator server ì—ì„œ í™•ì¸í•©ë‹ˆë‹¤.

</PreviewDescription>

<BrowserWindow url="https://github.com/mlops-for-mle/mlops-for-mle/tree/main/ch1">

í•´ë‹¹ íŒŒíŠ¸ì˜ ì „ì²´ ì½”ë“œëŠ” [mlops-for-mle/ch1/](https://github.com/mlops-for-mle/mlops-for-mle/tree/main/ch1) ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```js
ch1
// highlight-next-line
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ Makefile
â”œâ”€â”€ create_table.py
// highlight-next-line
â”œâ”€â”€ data_generator.py
// highlight-next-line
â”œâ”€â”€ docker-compose.yaml
â”œâ”€â”€ insert_data.py
â””â”€â”€ insert_data_loop.py
```

</BrowserWindow>

## 0. í™˜ê²½ ì„¤ì •

:::caution

ğŸ“Œ ì´ë²ˆ ì±•í„°ì—ì„œëŠ” Docker Compose ë¥¼ ì´ìš©í•˜ì—¬ ì»¨í…Œì´ë„ˆë¥¼ ë„ìš°ëŠ” ë²•ì— ëŒ€í•´ì„œ ì‹¤ìŠµí•©ë‹ˆë‹¤.  
ğŸ“Œ ì´ë¥¼ ìœ„í•´ì„œ ì•ì„œ <Chapter>1) DB Server Creation</Chapter> ì±•í„°ì™€ <Chapter>5) Data Generator on Docker</Chapter> ì±•í„°ì—ì„œ ì‹œì‘í•œ ì»¨í…Œì´ë„ˆë¥¼ ì¢…ë£Œí•´ì•¼ í•©ë‹ˆë‹¤. 
:::
 

ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ í†µí•´ ì‹¤í–‰ì¤‘ì¸ DB ì„œë²„ì™€ data generator ë¥¼ ì¢…ë£Œì‹œí‚µë‹ˆë‹¤.

```bash
# terminal-command
docker rm --force postgres-server data-generator
```

## 1. Dockerfile

<Chapter>5) Data Generator on Docker</Chapter> ì±•í„°ì—ì„œ ì‘ì„±í•œ <code>Dockerfile</code> ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

```docker  title="Dockerfile"
FROM amd64/python:3.9-slim

RUN apt-get update && apt-get install -y \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /usr/app

RUN pip install -U pip &&\
    pip install scikit-learn pandas psycopg2-binary

COPY data_generator.py data_generator.py

ENTRYPOINT ["python", "data_generator.py", "--db-host"]
# Change CMD to solve host finding error
CMD ["localhost"]
```

## 2. Docker Compose

ì´ì œ Compose íŒŒì¼ì„ ì‘ì„±í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

Compose íŒŒì¼ì˜ ì•„í‚¤í…ì²˜ëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

<CodeDescription>

```yaml  title="docker-compose.yaml"
version: "3"

services:
  postgres-server:
    ...
  data-generator:
    ...
```

- <var>version</var> : 

  - Compose íŒŒì¼ì˜ ë²„ì „ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ìµœì‹  ë²„ì „ì€ [ê³µì‹ í™ˆí˜ì´ì§€](https://docs.docker.com/compose/compose-file/compose-versioning/)ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  - ì´ë²ˆ ì±•í„°ì—ì„œëŠ” ì‘ì„±ì¼ ê¸°ì¤€ ìµœì‹  ë²„ì „ì¸ <code>3</code> ì„ ì‚¬ìš©í•˜ê² ìŠµë‹ˆë‹¤.
- <var>services</var> : 

  - Compose ì— ë¬¶ì¼ ì„œë¹„ìŠ¤ë“¤ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. í•˜ë‚˜ì˜ ì„œë¹„ìŠ¤ëŠ” í•˜ë‚˜ì˜ ì»¨í…Œì´ë„ˆë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.
  - <var>postgres-server</var> : <Chapter>01) DB Server Creation</Chapter> ì±•í„°ì—ì„œ ì‚¬ìš©í•œ DB ì„œë²„ë¥¼ ì‹¤í–‰ì‹œí‚¤ê¸° ìœ„í•œ ë‚´ìš©ì„ ì •ì˜í•  ì„œë¹„ìŠ¤ ì´ë¦„ì…ë‹ˆë‹¤.
  - <var>data-generator</var> : <Chapter>05) Data Generator on Docker</Chapter> ì±•í„°ì—ì„œ ì‚¬ìš©í•œ data generator ë¥¼ ì‹¤í–‰ì‹œí‚¤ê¸° ìœ„í•œ ë‚´ìš©ì„ ì •ì˜í•  ì„œë¹„ìŠ¤ ì´ë¦„ì…ë‹ˆë‹¤.

</CodeDescription>

ì´ì œ ë°ì´í„°ë¥¼ ì €ì¥í•  postgres server ì„œë¹„ìŠ¤ì™€ ë°ì´í„°ë¥¼ ìƒì„±í•  data generator ì„œë¹„ìŠ¤ë¥¼ ì‘ì„±í•´ ë³´ê² ìŠµë‹ˆë‹¤.

### 2.1 Postgres Server Service

ë¨¼ì €, `postgres-server` ì„œë¹„ìŠ¤ë¥¼ ì•„ë˜ì™€ ê°™ì´ yaml í˜•íƒœë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
`postgres-server` ì„œë¹„ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê°’ë“¤ì€ <Chapter>01) DB Server Creation</Chapter> ì±•í„°ì—ì„œ ì‚¬ìš©í•œ ê°’ê³¼ ê°™ì€ ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

<CodeDescription>

```yaml  title="docker-compose.yaml"
version: "3"

services:
  postgres-server:
    image: postgres:14.0
    container_name: postgres-server
    ports:
      - 5432:5432
    environment:
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
      POSTGRES_DB: mydatabase
```

- <var>postgres-server</var> :
  
  - ì„œë¹„ìŠ¤ì˜ ì´ë¦„ì…ë‹ˆë‹¤.
  - ì…ë ¥í•œ ì´ë¦„ì€ ì‹¤í–‰ë˜ëŠ” ì»¨í…Œì´ë„ˆì˜ í˜¸ìŠ¤íŠ¸ ì´ë¦„ì´ ë©ë‹ˆë‹¤.
- <var>image</var> :
  
  - ì‚¬ìš©í•  ì»¨í…Œì´ë„ˆì˜ ì´ë¯¸ì§€ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.
- <var>ports</var> : 
  
  - ì»¨í…Œì´ë„ˆì—ì„œ ì™¸ë¶€ë¡œ ë…¸ì¶œí•  í¬íŠ¸ í¬ì›Œë”©ì„ ì„¤ì •í•©ë‹ˆë‹¤.  
  - í˜•ì‹ì€ <code>host:container</code> ë¡œ ì‚¬ìš©ë˜ë©° ì—¬ëŸ¬ ê°œë¥¼ ì§€ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- <var>environment</var> :

  - ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•  ë•Œ ì‚¬ìš©í•œ <code>-e</code> ì˜µì…˜ê³¼ ê°™ì€ ì—­í• ì„ í•©ë‹ˆë‹¤.

</CodeDescription>

### 2.2 Data Generator Service

ë‹¤ìŒìœ¼ë¡œ, `data-generator` ì„œë¹„ìŠ¤ë¥¼ ì•„ë˜ì™€ ê°™ì´ yaml í˜•íƒœë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
`postgres-server` ì„œë¹„ìŠ¤ì™€ ë‹¤ë¥´ê²Œ ì´ë²ˆì—ëŠ” ì§ì ‘ ì´ë¯¸ì§€ë¥¼ build í•´ì„œ ì‚¬ìš©í•©ë‹ˆë‹¤.

<CodeDescription>

```yaml  title="docker-compose.yaml"
  data-generator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: data-generator
    depends_on:
      - postgres-server
    command: ["postgres-server"]
```

- <var>build</var> :

  - <var>context</var> : ì´ë¯¸ì§€ë¥¼ build í•˜ê¸° ìœ„í•´ Dockerfile ì´ ìˆëŠ” ì ˆëŒ€ê²½ë¡œ ë˜ëŠ” ìƒëŒ€ê²½ë¡œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
  - <var>dockerfile</var> : <var>context</var> ì—ì„œ ì„¤ì •í•œ ê²½ë¡œì— ìˆëŠ” Dockerfile ì˜ íŒŒì¼ëª…ì„ ì…ë ¥í•©ë‹ˆë‹¤.
- <var>depends_on</var> :
  
  - Compose ë¡œ ë„ì›Œì§€ëŠ” ì„œë¹„ìŠ¤ ê°„ì˜ ì¢…ì†ì„± ìˆœì„œëŒ€ë¡œ ì„œë¹„ìŠ¤ë¥¼ ì‹œì‘í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
  - ì—¬ê¸°ì„œëŠ” postgres server ê°€ ë¨¼ì € ì‹¤í–‰ë˜ê³  ë‚œ ë’¤ì— data generator ë¥¼ ì‹¤í–‰í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— postgres server ì˜ ì„œë¹„ìŠ¤ ì´ë¦„ì¸ `postgres-server` ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.
- <var>command</var> :
  
  - Dockerfileì— ì‘ì„±ë˜ì–´ ìˆëŠ” <code>CMD</code> ë¥¼ ë®ì–´ì”ë‹ˆë‹¤.
  - <Chapter>5) Data Generator on Docker</Chapter> ì±•í„°ì—ì„œ ì‘ì„±í•œ data generator ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” postgres server ì˜ í˜¸ìŠ¤íŠ¸ë¥¼ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
  - í˜¸ìŠ¤íŠ¸ ì´ë¦„ì€ ìœ„ì—ì„œ ì–¸ê¸‰í•œ ê²ƒì²˜ëŸ¼ ì»¨í…Œì´ë„ˆì˜ ì´ë¦„ìœ¼ë¡œ ì£¼ì–´ì•¼ í•˜ê¸° ë•Œë¬¸ì— `["postgres-server"]` ë¡œ ë®ì–´ì”ë‹ˆë‹¤.

</CodeDescription>

### 2.3 Docker Compose Healthcheck

ì•ì„œ ì‘ì„±í•œ `docker-compose.yaml` íŒŒì¼ì˜ ë‚´ìš©ì„ í•¨ê»˜ ë‚˜ì—´í•˜ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

```yaml  title="docker-compose.yaml"
version: "3"

services:
  postgres-server:
    image: postgres:14.0
    container_name: postgres-server
    ports:
      - 5432:5432
    environment:
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
      POSTGRES_DB: mydatabase

  data-generator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: data-generator
    depends_on:
      - postgres-server
    command: ["postgres-server"]
```

ì´ì œ ì‘ì„±í•œ Compose íŒŒì¼ì„ ì‹¤í–‰í•´ë³´ê² ìŠµë‹ˆë‹¤.  
Compose íŒŒì¼ì€ `up` ëª…ë ¹ì–´ì™€ `down` ëª…ë ¹ì–´ë¥¼ í†µí•´ ì‹¤í–‰ê³¼ ì¢…ë£Œë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<CodeDescription>

```bash
# terminal-command
docker compose up -d
```
- <var>-d</var> : 

  - Detached ëª¨ë“œë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤. Detached ëª¨ë“œë€, ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰ í›„ ìœ ì§€ì‹œí‚¤ëŠ” ëª¨ë“œë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.

</CodeDescription>

í•˜ì§€ë§Œ `docker ps` ë¥¼ ì…ë ¥í•´ë³´ë©´ postgres server ë§Œ ë„ì›Œì ¸ìˆìŠµë‹ˆë‹¤.

:::info

í•˜ë“œì›¨ì–´ ìŠ¤í™ì— ë”°ë¼ ë”°ë¼ í•´ë‹¹ ë‚´ìš©ì´ ì¬í˜„ì´ ì•ˆ ë˜ëŠ” ê²½ìš°ë„ ìˆìŠµë‹ˆë‹¤.  
ì¬í˜„ì´ ì•ˆë˜ëŠ” ê²½ìš°, ì „ì²´ íë¦„ì— ì´ˆì ì„ ë§ì¶°ì„œ ë´ì£¼ì‹œë©´ ë  ê²ƒ ê°™ìŠµë‹ˆë‹¤.

:::

```bash
# terminal-command
docker ps
CONTAINER ID   IMAGE           COMMAND                  CREATED              STATUS              PORTS                    NAMES
8a4a16837f28   postgres:14.0   "docker-entrypoint.sâ€¦"   About a minute ago   Up About a minute   0.0.0.0:5432->5432/tcp   postgres-server
```

Docker desktop ìœ¼ë¡œ ë´ë„ ë™ì¼í•œ í˜„ìƒì…ë‹ˆë‹¤.

<div style={{textAlign: 'center'}}>

![Container Networking Connetected](./img/db-5.png)  
[ê·¸ë¦¼ 1-5] Docker Desktop
</div>

ì™œ ì´ëŸ´ê¹Œìš”?

ì´ìœ ëŠ” ì•ì„œ `depends_on` ìœ¼ë¡œ ì„œë¹„ìŠ¤ ê°„ì˜ ì¢…ì†ì„±ì€ ì •í–ˆì§€ë§Œ, ì‹¤ì œë¡œ postgres server ê°€ ë„ì›Œì§„ ë’¤ì— ê³§ë°”ë¡œ data generator ê°€ ë„ì›Œì§‘ë‹ˆë‹¤.
Postgres server ëŠ” ì•„ì§ ì¤€ë¹„ê°€ ë˜ì–´ìˆì§€ ì•Šì€ë° data generator ê°€ ë„ì›Œì ¸ì„œ DB connection ì„ í•˜ë ¤ë‹¤ë³´ë‹ˆ data generator ê°€ Exited ë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•œ ê²ƒì…ë‹ˆë‹¤.

ë”°ë¼ì„œ postgres server ê°€ ì‚¬ìš© ê°€ëŠ¥í•œ ìƒíƒœê°€ ë˜ì–´ìˆëŠ”ì§€ ì²´í¬ë¥¼ í•œ ë’¤ì— data generator ë¥¼ ë„ì›Œì•¼ í•©ë‹ˆë‹¤.  
ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ë°©ë²•ìœ¼ë¡œ [Docker Compose Healthcheck](https://github.com/peter-evans/docker-compose-healthcheck) ê°€ ìˆìŠµë‹ˆë‹¤.

ê°„ë‹¨í•˜ê²Œ ì•„ë˜ì™€ ê°™ì´ yaml íŒŒì¼ì— `healthcheck` ë¶€ë¶„ê³¼ `condition` ì„ ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤.

<CodeDescription>

```yaml  title="docker-compose.yaml"
version: "3"

services:
  postgres-server:
    image: postgres:14.0
    container_name: postgres-server
    ports:
      - 5432:5432
    environment:
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
      POSTGRES_DB: mydatabase
    healthcheck:
      test: ["CMD", "pg_isready", "-q", "-U", "myuser", "-d", "mydatabase"]
      interval: 10s
      timeout: 5s
      retries: 5

  data-generator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: data-generator
    depends_on:
      postgres-server:
        condition: service_healthy
    command: ["postgres-server"]
```

- <var>test</var> : 
  
  - í…ŒìŠ¤íŠ¸ í•  ëª…ë ¹ì–´ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
  - ì´ë²ˆ ì±•í„°ì—ì„œëŠ” `pg_isready` ë¥¼ ì´ìš©í•˜ì—¬ DB ê°€ ì¤€ë¹„ìƒíƒœì¸ì§€ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ê¸° ë•Œë¬¸ì— <code>["CMD", "pg_isready", "-q", "-U", "myuser", "-d", "mydatabase"]</code> ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.
- <var>interval</var> : 
  
  - Healthcheck ê°„ê²©ì„ ì„¤ì •í•©ë‹ˆë‹¤.
  - ì´ë²ˆ ì±•í„°ì—ì„œëŠ” 10ì´ˆë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
- <var>timeout</var> : 
  
  - Healthcheck ì˜ timeout ì„ ì„¤ì •í•©ë‹ˆë‹¤.
  - ì´ë²ˆ ì±•í„°ì—ì„œëŠ” 5ì´ˆë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
- <var>retries</var> : 
  
  - Timeout ì˜ íšŸìˆ˜ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
  - ì´ë²ˆ ì±•í„°ì—ì„œëŠ” 5ë²ˆìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
- <var>condition</var> : 
  
  - Healthcheck ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ <var>depends_on</var> ì˜ parameter ë¡œ <code>condition: service_healthy</code> ë¥¼ ë„£ì–´ì¤ë‹ˆë‹¤.
  - Postgres server ì˜ healthcheck ë¥¼ data generator ì—ì„œ ì ìš©ì‹œí‚¤ê¸° ìœ„í•´ `postgres-server` ë°‘ì— condition ì„ ì¶”ê°€í•˜ì˜€ìŠµë‹ˆë‹¤.

</CodeDescription>

ì´ë ‡ê²Œ ì„¤ì •ëœ ê²ƒì„ ì¢…í•©í•´ë³´ë©´, 10ì´ˆë§ˆë‹¤ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í–ˆì„ ë•Œ 5ì´ˆ ì´ë‚´ì— DB ê°€ ì¤€ë¹„ ìƒíƒœê°€ ë˜ì—ˆëŠ”ì§€ë¥¼ ì²´í¬í•  ê²ƒì´ë©°, ì‹¤íŒ¨ ì‹œ 5ë²ˆ ì¬ì‹œë„í•œë‹¤ëŠ” ëœ»ì´ ë©ë‹ˆë‹¤.
ì´ì™¸ì— ë” ìì„¸í•œ ë‚´ìš©ì€ [Dockerfile Reference](https://docs.docker.com/engine/reference/builder/#healthcheck) ì„ ì°¸ê³ í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.

ì´ì œ ë‹¤ì‹œ ì„œë¹„ìŠ¤ë“¤ì„ ì‹¤í–‰í•´ë³´ê² ìŠµë‹ˆë‹¤.

```bash
# terminal-command
docker compose up -d
```

ë¬¸ì œì—†ì´ ì˜ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 2.4 Docker Compose Network
#### 2.4.1 Default Network

<Chapter> 5) Data Generator on Docker</Chapter> ì±•í„°ì—ì„œ ì»¨í…Œì´ë„ˆë“¤ë¼ë¦¬ ë„¤íŠ¸ì›Œí¬ë¥¼ ì—°ê²°í•˜ëŠ” ë¶€ë¶„ì„ ì„¤ëª…í–ˆì—ˆìŠµë‹ˆë‹¤.
ìœ„ì˜ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•œ í›„ ìƒì„±ëœ ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.

```bash
# terminal-command
docker network ls
```

ì‹¤í–‰í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ `ch1_default` ë¼ëŠ” ì´ë¦„ì˜ ë„¤íŠ¸ì›Œí¬ê°€ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```
NETWORK ID     NAME          DRIVER    SCOPE
d2a7834f5caa   bridge        bridge    local
d7d45bd4c3b7   ch1_default   bridge    local
0d5dc37e7a9d   host          host      local
703a7cd222a5   none          null      local
```

`ch1_default` ë¥¼ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.
```bash
# terminal-command
docker network inspect ch1_default
```

ë„¤íŠ¸ì›Œí¬ì— ìë™ìœ¼ë¡œ `postgres-server` ì™€ `data-generator` ì»¨í…Œì´ë„ˆê°€ ì¶”ê°€ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
[
    {
        "Name": "ch1_default",
        ...
        "ConfigOnly": false,
        "Containers": {
            "4043d0d2df3673a5fac77945bb7746e1af4b352fb7617891de0b22357a877c59": {
                "Name": "postgres-server",
                ...
            },
            "4ffdc089e4a40727645a0cab1952c025cdd583031f3ce7867761305ead2a6d63": {
                "Name": "data-generator",
                ...
            }
        ...
    }
]
```
ì´ì²˜ëŸ¼ Compose íŒŒì¼ì„ ì‚¬ìš©í•˜ë©´ ë„¤íŠ¸ì›Œí¬ì— ëŒ€í•´ì„œ ì‹ ê²½ì“°ì§€ ì•Šê³  í¸ë¦¬í•˜ê²Œ ì»¨í…Œì´ë„ˆë“¤ì„ ì—°ê²°í•´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### 2.4.2 Custom Network
ë„¤íŠ¸ì›Œí¬ì˜ ì´ë¦„ì€ íŠ¹ë³„íˆ ì§€ì •í•˜ì§€ ì•Šì„ ê²½ìš° `{ë””ë ‰í† ë¦¬ëª…}_default` ë¡œ ìë™ìœ¼ë¡œ ìƒì„±ì´ ë©ë‹ˆë‹¤.
ê·¸ë ‡ê¸° ë•Œë¬¸ì— ì„œë¡œ ê°™ì€ ë””ë ‰í† ë¦¬ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì„ ê²½ìš° ë„¤íŠ¸ì›Œí¬ì˜ ì´ë¦„ì´ ë³€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì•ìœ¼ë¡œ ì´ì–´ì§€ëŠ” íŒŒíŠ¸ì—ì„œëŠ” ì„œë¡œ ë„¤íŠ¸ì›Œí¬ì˜ ì—°ê²°ì´ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— ì´ë¦„ì„ ì§€ì •í•´ì„œ ìƒì„±í•˜ê² ìŠµë‹ˆë‹¤.

ë¨¼ì € ì‹¤í–‰í•œ ì„œë¹„ìŠ¤ë“¤ì„ ì¢…ë£Œí•˜ê² ìŠµë‹ˆë‹¤.

<CodeDescription>

```bash
docker compose down -v
```
- <var>-v</var> : 

  - ìƒì„±ëœ ë³¼ë¥¨ê¹Œì§€ ì‚­ì œí•©ë‹ˆë‹¤.

</CodeDescription>

ë„¤íŠ¸ì›Œí¬ ìƒì„±ì€ `services` ì™€ ê°™ì€ ë ˆë²¨ì— `networks` ë¥¼ ì…ë ¥í•˜ë©´ ë©ë‹ˆë‹¤.

<CodeDescription>

```yaml  title="docker-compose.yaml"
networks:
  default:
    name: mlops-network
```
- <var>default</var> : ì„œë¹„ìŠ¤ ì „ì²´ì˜ ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

  - <var>name</var> : ë„¤íŠ¸ì›Œí¬ì˜ ì´ë¦„ì„ ì‘ì„±í•©ë‹ˆë‹¤. ì•ìœ¼ë¡œ ì´ì–´ì§€ëŠ” íŒŒíŠ¸ì—ì„œë„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ <code>mlops-network</code> ë¡œ ì‘ì„±í•˜ê² ìŠµë‹ˆë‹¤.

</CodeDescription>

#### 2.4.3 ì‹¤í–‰

ë„¤íŠ¸ì›Œí¬ê¹Œì§€ ì‘ì„±í•œ ìµœì¢… Compose íŒŒì¼ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```yaml  title="docker-compose.yaml"
version: "3"

services:
  postgres-server:
    image: postgres:14.0
    container_name: postgres-server
    ports:
      - 5432:5432
    environment:
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: mypassword
      POSTGRES_DB: mydatabase
    healthcheck:
      test: ["CMD", "pg_isready", "-q", "-U", "myuser", "-d", "mydatabase"]
      interval: 10s
      timeout: 5s
      retries: 5

  data-generator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: data-generator
    depends_on:
      postgres-server:
        condition: service_healthy
    command: ["postgres-server"]

networks:
  default:
    name: mlops-network

```

ë‹¤ì‹œ `docker compose` ë¥¼ ì‹¤í–‰í•´ ë³´ê² ìŠµë‹ˆë‹¤.

```bash
# terminal-command
docker compose up -d
```

ì‹¤í–‰ í›„ ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.

```bash
# terminal-command
docker network ls
```

ë‹¤ìŒê³¼ ê°™ì´ `mlops-network` ê°€ ì¶”ê°€ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```
NETWORK ID     NAME            DRIVER    SCOPE
d2a7834f5caa   bridge          bridge    local
0d5dc37e7a9d   host            host      local
e9671c141955   mlops-network   bridge    local
703a7cd222a5   none            null      local
```

## 3. ë°ì´í„° í™•ì¸

### 3.1 In Local

`psql` ì„ ì´ìš©í•˜ì—¬ DB ì— ì ‘ì†í•˜ê³ , ê³„ì†í•´ì„œ ë°ì´í„°ê°€ ì‚½ì…ë˜ê³  ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

```bash
# terminal-command
PGPASSWORD=mypassword psql -h localhost -p 5432 -U myuser -d mydatabase
psql (14.3, server 14.0 (Debian 14.0-1.pgdg110+1))
Type "help" for help.

mydatabase=# select * from iris_data;
 id | sepal_length | sepal_width | petal_length | petal_width | target 
----+--------------+-------------+--------------+-------------+--------
  1 |            6 |         2.9 |          4.5 |         1.5 |      1
  2 |          6.9 |         3.1 |          5.4 |         2.1 |      2
  3 |          5.1 |         3.7 |          1.5 |         0.4 |      0
  4 |          6.3 |         2.7 |          4.9 |         1.8 |      2
  5 |          4.4 |         2.9 |          1.4 |         0.2 |      0
  6 |          4.7 |         3.2 |          1.3 |         0.2 |      0
```

### 3.2 In Data Generator Container

`docker exec` ë¥¼ ì´ìš©í•˜ì—¬ data generator ì»¨í…Œì´ë„ˆ ì•ˆìœ¼ë¡œ ì ‘ì†í•©ë‹ˆë‹¤.

```bash
# terminal-command
docker exec -it data-generator /bin/bash
```

ê·¸ë¦¬ê³  `psql` ì„ ì´ìš©í•˜ì—¬ DB ë¡œ ì ‘ì†í•©ë‹ˆë‹¤.
ì´ ë•Œ local ì´ ì•„ë‹Œ data generator ì»¨í…Œì´ë„ˆì—ì„œ ì ‘ì†í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— í˜¸ìŠ¤íŠ¸ë¥¼ `localhost` ì—ì„œ `postgres-server` ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.

```bash
# terminal-command
PGPASSWORD=mypassword psql -h postgres-server -p 5432 -U myuser -d mydatabase
psql (13.8 (Debian 13.8-0+deb11u1), server 14.0 (Debian 14.0-1.pgdg110+1))
WARNING: psql major version 13, server major version 14.
         Some psql features might not work.
Type "help" for help.

mydatabase=# select * from iris_data;
 id | sepal_length | sepal_width | petal_length | petal_width | target 
----+--------------+-------------+--------------+-------------+--------
  1 |            6 |         2.9 |          4.5 |         1.5 |      1
  2 |          6.9 |         3.1 |          5.4 |         2.1 |      2
  3 |          5.1 |         3.7 |          1.5 |         0.4 |      0
  4 |          6.3 |         2.7 |          4.9 |         1.8 |      2
  5 |          4.4 |         2.9 |          1.4 |         0.2 |      0
  6 |          4.7 |         3.2 |          1.3 |         0.2 |      0
```
