---
sidebar_position: 4
description: ğŸ“Œ ìƒì„±ëœ í…Œì´ë¸”ì•ˆì— ë°ì´í„°ë¥¼ ê³„ì†í•´ì„œ ìƒì„±í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.
---

# 4) Data Insertion Loop
import CodeDescription from '@site/src/components/CodeDescription';
import BrowserWindow from '@site/src/components/BrowserWindow';
import { Chapter, Part } from '@site/src/components/Highlight';

### ëª©í‘œ

1. ìƒì„±ëœ í…Œì´ë¸”ì•ˆì— ë°ì´í„°ë¥¼ ê³„ì†í•´ì„œ ìƒì„±í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.
2. DB ì— ë°ì´í„°ê°€ ê³„ì†í•´ì„œ ì‚½ì…ë˜ê³  ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

<details>
<summary>ìŠ¤í™ ëª…ì„¸ì„œ</summary>
<CodeDescription>

### ìŠ¤í™ ëª…ì„¸ì„œ

1.  <Chapter>3) Data Insertion </Chapter> ì±•í„°ì—ì„œ ì‘ì„±í•œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì´ìš©í•˜ì—¬ ê³„ì†í•´ì„œ ë°ì´í„°ë¥¼ ìƒì„±í•˜ëŠ” data generator ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë§Œë“­ë‹ˆë‹¤.
2. `psycopg2` ë¥¼ ì´ìš©í•˜ì—¬ ìƒì„±ëœ `iris_data` í…Œì´ë¸”ì— ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ì—¬ ê³„ì†í•´ì„œ ë°ì´í„°ë¥¼ ì‚½ì…í•©ë‹ˆë‹¤.
3. `psql` ì„ ì´ìš©í•˜ì—¬ ì‚½ì…í•œ ë°ì´í„°ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.

</CodeDescription>
</details>

---

<BrowserWindow url="https://github.com/mlops-for-mle/mlops-for-mle/tree/main/ch1">

í•´ë‹¹ íŒŒíŠ¸ì˜ ì „ì²´ ì½”ë“œëŠ” [mlops-for-mle/ch1/](https://github.com/mlops-for-mle/mlops-for-mle/tree/main/ch1) ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```js
ch1
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ Makefile
â”œâ”€â”€ create_table.py
â”œâ”€â”€ data_generator.py
â”œâ”€â”€ docker-compose.yaml
â”œâ”€â”€ insert_data.py
// highlight-next-line
â””â”€â”€ insert_data_loop.py
```

</BrowserWindow>

## 1. ë°ì´í„° ìƒì„±

### 1.1 Generate Data

 <Chapter>3) Data Insertion </Chapter> ì±•í„°ì—ì„œ ì‘ì„±í•œ `insert_data.py` ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ê³„ì†í•´ì„œ ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ëŠ” `insert_data_loop.py` ë¥¼ ì‘ì„±í•´ ë³´ê² ìŠµë‹ˆë‹¤.

ê³„ì†í•´ì„œ ë°ì´í„°ë¥¼ ì‚½ì…í•˜ê¸° ìœ„í•´ while ë¬¸ì„ ì‚¬ìš©í•˜ê² ìŠµë‹ˆë‹¤. ì´ ë•Œ `while True` ë¥¼ í†µí•´ ì™¸ë¶€ì˜ ê°œì…ì´ ì—†ë‹¤ë©´ ê³„ì†í•´ì„œ while ë¬¸ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```python
def generate_data(db_connect, df):
    while True:
        insert_data(db_connect, df.sample(5).squeeze())
```

ë‹¤ë§Œ ìœ„ì™€ ê°™ì´ ì‘ì„±í•  ê²½ìš° ë„ˆë¬´ ë¹ ë¥¸ ì‹œê°„ì— ë°ì´í„°ê°€ ì¶”ê°€ë˜ê¸° ë•Œë¬¸ì— DB ì— ë¶€í•˜ê°€ ìƒê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.  
ì´ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ì„œëŠ” ë°ì´í„°ë¥¼ ì‚½ì… í›„ ì ì‹œ ëŒ€ê¸°í•˜ëŠ” ì‹œê°„ì„ ì¶”ê°€í•˜ê² ìŠµë‹ˆë‹¤. íŒŒì´ì¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ëŒ€ê¸°ì‹œí‚¤ëŠ” ê²ƒì€ `time` íŒ¨í‚¤ì§€ì˜ `sleep` í•¨ìˆ˜ë¥¼ ì´ìš©í•˜ë©´ ë©ë‹ˆë‹¤. ì´ í•¨ìˆ˜ê°€ ì‹¤í–‰ë  ê²½ìš° í•´ë‹¹ ì¤„ì—ì„œ ì§€ì •ëœ ì‹œê°„ë§Œí¼ ëŒ€ê¸°ë¥¼ í•©ë‹ˆë‹¤.  
ì—¬ê¸°ì„œëŠ” 1ì´ˆê°„ ë©ˆì¶”ê²Œ í•´ë³´ê² ìŠµë‹ˆë‹¤.

```python
import time

def generate_data(db_connect, df):
    while True:
        insert_data(db_connect, df.sample(1).squeeze())
        time.sleep(1)
```

### 1.2 Query ì‹¤í–‰

#### 1.2.1 `insert_data_loop.py`

 <Chapter>3) Data Insertion </Chapter> ì±•í„°ì—ì„œ ì‘ì„±í•œ ë‚´ìš©ë“¤ê³¼ ì´ë²ˆ ì±•í„°ì—ì„œ ì„¤ëª…í•œ ë‚´ìš©ì„ í•©ì³ì„œ data generator ë¥¼ ìƒì„±í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

```python  title="insert_data_loop.py"
# insert_data_loop.py
import time

import pandas as pd
import psycopg2
from sklearn.datasets import load_iris

def get_data():
    X, y = load_iris(return_X_y=True, as_frame=True)
    df = pd.concat([X, y], axis="columns")
    rename_rule = {
        "sepal length (cm)": "sepal_length",
        "sepal width (cm)": "sepal_width",
        "petal length (cm)": "petal_length",
        "petal width (cm)": "petal_width",
    }
    df = df.rename(columns=rename_rule)
    return df

def insert_data(db_connect, data):
    insert_row_query = f"""
    INSERT INTO iris_data
        (sepal_length, sepal_width, petal_length, petal_width, target)
        VALUES (
            {data.sepal_length},
            {data.sepal_width},
            {data.petal_length},
            {data.petal_width},
            {data.target}
        );
    """
    print(insert_row_query)
    with db_connect.cursor() as cur:
        cur.execute(insert_row_query)
        db_connect.commit()


def generate_data(db_connect, df):
    while True:
        insert_data(db_connect, df.sample(1).squeeze())
        time.sleep(1)


if __name__ == "__main__":
    db_connect = psycopg2.connect(
        user="myuser",
        password="mypassword",
        host="localhost",
        port=5432,
        database="mydatabase",
    )
    df = get_data()
    generate_data(db_connect, df)
```

#### 1.2.2 ì‹¤í–‰

Python íŒŒì¼ì„ ì‹¤í–‰í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ë‚˜ì˜µë‹ˆë‹¤.

```bash
# terminal-command
python data_generator.py

    CREATE TABLE IF NOT EXISTS iris_data (
        id SERIAL PRIMARY KEY,
        sepal_length float8,
        sepal_width float8,
        petal_length float8,
        petal_width float8,
        target int
    );

    INSERT INTO iris_data
        (sepal_length, sepal_width, petal_length, petal_width, target)
        VALUES (
            6.5,
            2.8,
            4.6,
            1.5,
            1.0
        );
    

    INSERT INTO iris_data
        (sepal_length, sepal_width, petal_length, petal_width, target)
        VALUES (
            5.5,
            4.2,
            1.4,
            0.2,
            0.0
        );
    

    INSERT INTO iris_data
        (sepal_length, sepal_width, petal_length, petal_width, target)
        VALUES (
            4.4,
            2.9,
            1.4,
            0.2,
            0.0
        );
```

## 2. Data í™•ì¸

`psql` ì„ ì´ìš©í•˜ì—¬ DB ì— ì ‘ê·¼í•˜ê³ , ê³„ì†í•´ì„œ data ê°€ ì‚½ì…ë˜ê³  ìˆëŠ”ì§€ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.

1. psql ì— ì ‘ì†í•©ë‹ˆë‹¤.
    
    ```bash
    # terminal-command
    psql -h localhost -p 5432 -U myuser -d mydatabase
    Password for user myuser: 
    psql (14.3, server 14.0 (Debian 14.0-1.pgdg110+1))
    Type "help" for help.
    
    mydatabase=#
    ```
    
2.  <Chapter>3) Data Insertion </Chapter> ì±•í„°ì—ì„œ ì‘ì„±í•œ `iris_data` í…Œì´ë¸”ì— ìˆëŠ” ë°ì´í„° ì „ì²´ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•œ query ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
    
    ```bash
    # terminal-command
    mydatabase=# select * from iris_data;
     id | sepal_length | sepal_width | petal_length | petal_width | target 
    ----+--------------+-------------+--------------+-------------+--------
      1 |          5.6 |           3 |          4.5 |         1.5 |      1
      2 |          5.9 |           3 |          5.1 |         1.8 |      2
      3 |          5.5 |         2.4 |          3.8 |         1.1 |      1
      4 |          5.4 |         3.9 |          1.3 |         0.4 |      0
    (4 rows)
    ```
    
    ì‹¤í–‰ì„ í•  ë•Œë§ˆë‹¤ ê³„ì†í•´ì„œ ë°ì´í„°ê°€ ì¶”ê°€ë˜ê³  ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
