---
sidebar_position: 6
description: ğŸ“Œ Connect ì— Sink Connector ë¥¼ ë„ì›Œë´…ë‹ˆë‹¤.
---

# 6) Sink Connector
import CodeDescription from '@site/src/components/CodeDescription';
import PreviewDescription from '@site/src/components/PreviewDescription';
import BrowserWindow from '@site/src/components/BrowserWindow';
import { Chapter, Part } from '@site/src/components/Highlight';
import ArchitectureImage from './img/kafka-15.png';

<PreviewDescription>

## Chapter Preview
---
### ëª©í‘œ

1. Docker Compose ë¥¼ ì´ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ì „ë‹¬ë°›ì„ Target DB ì„œë²„ì™€ Table Creator ë¥¼ êµ¬ì¶•í•©ë‹ˆë‹¤.
2. Connect ì— Sink Connector ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
3. Target DB ì„œë²„ì— ë°ì´í„°ê°€ ì˜ ì „ë‹¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

### ìŠ¤í™ ëª…ì„¸ì„œ

1. Docker Compose ë¥¼ í†µí•´ Sink Connector ë¡œ ë°ì´í„°ë¥¼ ì „ë‹¬í•˜ì—¬ ì €ì¥í•  Target PostgreSQL DB ì„œë²„ì™€ DB ì— í…Œì´ë¸”ì„ ìƒì„±í•˜ëŠ” Table Creator ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    - Target DB Server
        - <var>Image</var> : <code>postgres:14.0</code>
        - <var>Container name</var> : <code>target-postgres-server</code>
        - <var>POSTGRES_USER</var> : <code>targetuser</code>
        - <var>POSTGRES_PASSWORD</var> : <code>targetpassword</code>
        - <var>POSTGRES_DB</var> : <code>targetdatabase</code>
        - <var>Port forwarding</var> : <code>5433:5432</code>
    - Table Creator
        - Dockerfile : 
            - psycopg2 íŒ¨í‚¤ì§€ë¥¼ ì´ìš©í•˜ì—¬ Target DB ì„œë²„ì— í…Œì´ë¸”ì„ ìƒì„±í•˜ëŠ” ì½”ë“œë¥¼ ë§Œë“  í›„ Dockerfile ì—ì„œ í•´ë‹¹ ì½”ë“œê°€ ì‹¤í–‰ë˜ë„ë¡ ì´ë¯¸ì§€ë¥¼ ë§Œë“­ë‹ˆë‹¤.
        - Docker Compose :
            - <var>Container name</var> : <code>table-creator</code>
2. Sink Connector ë¥¼ ë„ìš°ê¸° ìœ„í•œ ì„¤ì • íŒŒì¼ì„ ë§Œë“­ë‹ˆë‹¤.
    ```json
    {
        "name": "postgres-sink-connector",
        "config": {
            "connector.class": "io.confluent.connect.jdbc.JdbcSinkConnector",
            "connection.url": "jdbc:postgresql://target-postgres-server:5432/targetdatabase",
            "connection.user": "targetuser",
            "connection.password": "targetpassword",
            "table.name.format": "iris_data",
            "topics": "postgres-source-iris_data",
            "auto.create": false,
            "auto.evolve": false,
            "tasks.max": 2,
            "transforms": "TimestampConverter",
            "transforms.TimestampConverter.type": "org.apache.kafka.connect.transforms.TimestampConverter$Value",
            "transforms.TimestampConverter.field": "timestamp",
            "transforms.TimestampConverter.format": "yyyy-MM-dd HH:mm:ss.S",
            "transforms.TimestampConverter.target.type": "Timestamp"
        }
    }
    ```
2. <code>curl</code> ëª…ë ¹ì–´ë¥¼ ì´ìš©í•˜ì—¬ POST method ë¡œ Sink Connector ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

    - <var>URL</var> : <code>http://localhost:8083/connectors</code>
    - <var>Header</var> : <code>Content-Type: application/json</code>
3. Target DB ì„œë²„ì— ì ‘ì†í•˜ì—¬ ì €ì¥ëœ ë°ì´í„°ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.

</PreviewDescription>

<BrowserWindow url="https://github.com/mlops-for-mle/mlops-for-mle/tree/main/ch7">

í•´ë‹¹ íŒŒíŠ¸ì˜ ì „ì²´ ì½”ë“œëŠ” [mlops-for-mle/ch7/](https://github.com/mlops-for-mle/mlops-for-mle/tree/main/ch7) ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```js
ch7
â”œâ”€â”€ Makefile
â”œâ”€â”€ README.md
â”œâ”€â”€ connect.Dockerfile
// highlight-next-line
â”œâ”€â”€ create_table.py
â”œâ”€â”€ kafka-docker-compose.yaml
â”œâ”€â”€ naive-docker-compose.yaml
// highlight-next-line
â”œâ”€â”€ sink_connector.json
â”œâ”€â”€ source_connector.json
// highlight-next-line
â”œâ”€â”€ target-docker-compose.yaml
// highlight-next-line
â””â”€â”€ target.Dockerfile
```

</BrowserWindow>

## 1. Architecture
[ê·¸ë¦¼ 7-15]ì€ ì´ë²ˆ ì‹¤ìŠµì—ì„œ ë‹¤ë£° ì„œë¹„ìŠ¤ë“¤ì˜ ë‹¤ì´ì–´ê·¸ë¨ì…ë‹ˆë‹¤.

<div style={{textAlign: 'center'}}>

<img src={ArchitectureImage}/>
[ê·¸ë¦¼7-15] Kafka System

</div>

:::caution

ğŸ“Œ  í•´ë‹¹ íŒŒíŠ¸ëŠ” <Part>01. Database</Part> íŒŒíŠ¸ì˜ DB ë¥¼ ì´ìš©í•©ë‹ˆë‹¤.  
ğŸ“Œ  DB ë¥¼ ë„ìš°ì§€ ì•Šì€ ê²½ìš° <Part>01. Database</Part> íŒŒíŠ¸ë¥¼ ì™„ë£Œí•˜ê³  DB ê°€ ë„ì›Œì§„ ìƒíƒœì—ì„œ ì§„í–‰í•´ì£¼ì„¸ìš”.  

:::

## 2. Target Postgres Server

### 2.1 Table Creator

ì•„ë˜ì˜ ì½”ë“œëŠ” Target DB ë¥¼ ë„ìš´ ë‹¤ìŒì— í…Œì´ë¸”ë§Œ ìƒì„±í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ <Part>01. Database</Part> íŒŒíŠ¸ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.

```python  title="create_table.py"
# create_table.py
import psycopg2


def create_table(db_connect):
    create_table_query = """
    CREATE TABLE IF NOT EXISTS iris_data (
        id SERIAL PRIMARY KEY,
        timestamp timestamp,
        sepal_length float8,
        sepal_width float8,
        petal_length float8,
        petal_width float8,
        target int
    );"""
    print(create_table_query)
    with db_connect.cursor() as cur:
        cur.execute(create_table_query)
        db_connect.commit()


if __name__ == "__main__":
    db_connect = psycopg2.connect(
        user="targetuser",
        password="targetpassword",
        host="target-postgres-server",
        port=5432,
        database="targetdatabase",
    )
    create_table(db_connect)
```

Dockerfile ì„ ì´ìš©í•˜ì—¬ ìœ„ì—ì„œ ì‘ì„±í•œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ì´ë¯¸ì§€ë¥¼ ë§Œë“­ë‹ˆë‹¤.

```docker  title=target.Dockerfile
# target.Dockerfile
FROM amd64/python:3.9-slim

WORKDIR /usr/app

RUN pip install -U pip &&\
    pip install psycopg2-binary

COPY create_table.py create_table.py

ENTRYPOINT ["python", "create_table.py"]
```

### 2.2 ì‹¤í–‰

Docker Compose ë¥¼ ì´ìš©í•˜ì—¬ Target DB ì„œë²„ì™€ Table Creator ë¥¼ ë„ì›ë‹ˆë‹¤.

#### 2.2.1 `target-docker-compose.yaml`

ì „ì²´ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

```yaml  title="target-docker-compose.yaml"
# target-docker-compose.yaml
version: "3"

services:
  target-postgres-server:
    image: postgres:14.0
    container_name: target-postgres-server
    ports:
      - 5433:5432
    environment:
      POSTGRES_USER: targetuser
      POSTGRES_PASSWORD: targetpassword
      POSTGRES_DB: targetdatabase
    healthcheck:
      test: ["CMD", "pg_isready", "-q", "-U", "targetuser", "-d", "targetdatabase"]
      interval: 10s
      timeout: 5s
      retries: 5

  table-creator:
    build:
      context: .
      dockerfile: target.Dockerfile
    container_name: table-creator
    depends_on:
      target-postgres-server:
        condition: service_healthy

networks:
  default:
    name: mlops-network
    external: true
```

#### 2.2.2 ì‹¤í–‰
`docker compose` ëª…ë ¹ì–´ë¥¼ ì´ìš©í•˜ì—¬ ìœ„ì—ì„œ ì‘ì„±í•œ ì„œë¹„ìŠ¤ë“¤ì„ ë„ì›ë‹ˆë‹¤.

<CodeDescription>

```bash
# terminal-command
docker compose -p ch7-target -f target-docker-compose.yaml up -d
```

- <var>-p</var> : 

  - Project name ì€ <code>ch7-target</code> ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
- <var>-f</var> :

  - File name ì€ ìœ„ì—ì„œ ì‘ì„±í•œ íŒŒì¼ ì´ë¦„ì¸ <code>target-docker-compose.yaml</code> ì„ ì ì–´ì¤ë‹ˆë‹¤.

</CodeDescription>

## 3. Sink Connector

ë‹¤ìŒìœ¼ë¡œ ë¸Œë¡œì»¤ì˜ í† í”½ì—ì„œ Target DB ë¡œ ë°ì´í„°ë¥¼ ì „ë‹¬í•˜ëŠ” Sink Connector ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

### 3.1 ìƒì„±

Sink Connector ëŠ” Source Connector ì™€ ë§ˆì°¬ê°€ì§€ë¡œ Connect ì— API í˜¸ì¶œì„ í†µí•´ ìƒì„±í•©ë‹ˆë‹¤.
ì•„ë˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ Sink Connector ë¥¼ ë„ìš¸ ìˆ˜ ìˆëŠ” `sink_connector.json` ì„ ìƒì„±í•©ë‹ˆë‹¤.

```bash
# terminal-command
cat <<EOF > sink_connector.json
{
    "name": "postgres-sink-connector",
    "config": {
        "connector.class": "io.confluent.connect.jdbc.JdbcSinkConnector",
        "connection.url": "jdbc:postgresql://target-postgres-server:5432/targetdatabase",
        "connection.user": "targetuser",
        "connection.password": "targetpassword",
        "table.name.format": "iris_data",
        "topics": "postgres-source-iris_data",
        "auto.create": false,
        "auto.evolve": false,
        "tasks.max": 2,
        "transforms": "TimestampConverter",
        "transforms.TimestampConverter.type": "org.apache.kafka.connect.transforms.TimestampConverter$Value",
        "transforms.TimestampConverter.field": "timestamp",
        "transforms.TimestampConverter.format": "yyyy-MM-dd HH:mm:ss.S",
        "transforms.TimestampConverter.target.type": "Timestamp"
    }
}

EOF
```

ìƒì„±í•˜ëŠ” Sink Connector ì— ëŒ€í•œ ì„¤ì • íŒŒì¼ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

<CodeDescription>

```json  title="sink_connector.json"
{
    "name": "postgres-sink-connector",
    "config": {
        "connector.class": "io.confluent.connect.jdbc.JdbcSinkConnector",
        "connection.url": "jdbc:postgresql://target-postgres-server:5432/targetdatabase",
        "connection.user": "targetuser",
        "connection.password": "targetpassword",
        "table.name.format": "iris_data",
        "topics": "postgres-source-iris_data",
        "auto.create": false,
        "auto.evolve": false,
        "tasks.max": 2,
        "transforms": "TimestampConverter",
        "transforms.TimestampConverter.type": "org.apache.kafka.connect.transforms.TimestampConverter$Value",
        "transforms.TimestampConverter.field": "timestamp",
        "transforms.TimestampConverter.format": "yyyy-MM-dd HH:mm:ss.S",
        "transforms.TimestampConverter.target.type": "Timestamp"
    }
}

```

- <var>name</var> : 

  - Connector ì˜ ì´ë¦„ì„ ì •í•©ë‹ˆë‹¤.  
- <var>config</var> :

  - <var>connector.class</var> : 

    - Connector ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•œ class ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.  
    - ì´ë²ˆ ì±•í„°ì—ì„œëŠ” JDBC Sink Connector ë¥¼ ì‚¬ìš©í•¨ìœ¼ë¡œ <code>io.confluent.connect.jdbc.JdbcSinkConnector</code> ë¥¼ ê¸°ì…í•©ë‹ˆë‹¤.
  - <var>connection.url</var> : 
    
    - Target DB ì— ì ‘ê·¼í•˜ê¸° ìœ„í•œ ì£¼ì†Œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
    - ì´ë²ˆ ì±•í„°ì—ì„œëŠ” ì•ì„œ ë„ì›Œë‘ì—ˆë˜ Target DB ì„œë²„ì˜ URL ì¸ <code>jdbc:postgresql://target-postgres-server:5432/targetdatabase</code> ì„ ê¸°ì…í•©ë‹ˆë‹¤.
  - <var>connection.user</var> : 
    
    - Target DB ì— ì ‘ì†í•˜ê¸° ìœ„í•œ ìœ ì €ì˜ ì´ë¦„ì„ ì„¤ì •í•©ë‹ˆë‹¤.
  - <var>connection.password</var> : 
    
    - Target DB ì— ì ‘ì†í•˜ê¸° ìœ„í•œ ìœ ì €ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
  - <var>table.name.format</var> : 

    - Target DB ì— ì „ë‹¬í•  í…Œì´ë¸” ì´ë¦„ì˜ format ì„ ì„¤ì •í•©ë‹ˆë‹¤.
  - <var>topics</var> : 

    - Sink Connector ê°€ ë¸Œë¡œì»¤ì— ìˆëŠ” í† í”½ë“¤ ì¤‘ì— ê°€ì ¸ì˜¬ í† í”½ì„ ì„¤ì •í•©ë‹ˆë‹¤.
  - <var>auto.create</var> : 

    - í…Œì´ë¸”ì„ ìë™ìœ¼ë¡œ ìƒì„±í•  ì§€ì˜ ì—¬ë¶€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. 
    - ì´ë¯¸ í…Œì´ë¸”ì„ ìƒì„±í–ˆê¸° ë•Œë¬¸ì— <code>false</code> ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
  - <var>auto.evolve</var> : 

    - í…Œì´ë¸”ì— ìë™ìœ¼ë¡œ column ë“¤ì„ ìƒì„±í•  ì§€ì˜ ì—¬ë¶€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. 
    - ì´ë¯¸ í…Œì´ë¸”ì˜ column ë“¤ì„ ìƒì„±í–ˆê¸° ë•Œë¬¸ì— <code>false</code> ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
  - <var>tasks.max</var> : 

    - Connector ì—ì„œ task ì˜ ìˆ˜ë¥¼ ì–¼ë§ˆë‚˜ ê°€ì ¸ê°ˆ ì§€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
  - <var>transforms</var> : 
  
    - í† í”½ì— ìˆëŠ” string type ì˜ timestamp ê°’ì„ Target DB ë¡œ ì „ë‹¬í•  ë•Œ timestamp type ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ì „ë‹¬í•´ì•¼ í•©ë‹ˆë‹¤.
       ë”°ë¼ì„œ Sink Connector ë¥¼ ìƒì„±í•  ë•Œ <var>transforms</var> ì— ìˆëŠ” Timestamp Converter ë¥¼ ì´ìš©í•˜ì—¬ string type ì„ timestamp type ìœ¼ë¡œ ë³€ê²½ í›„, Target DB ì— ë°ì´í„°ë¥¼ ë„£ìŠµë‹ˆë‹¤.
    - Transformation ì„ ì ìš©í•  Converter ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
  - <var>transforms.TimestampConverter.type</var> : 

    - Timestamp Converter ì˜ type ì„ ì„¤ì •í•©ë‹ˆë‹¤.
    - Timestamp column ì€ key ì— ìˆëŠ” ê°’ì´ ì•„ë‹Œ value ì— ìˆëŠ” ê°’ì´ë¯€ë¡œ value ì— ëŒ€í•œ Timestamp Converter ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
  - <var>transforms.TimestampConverter.field</var> : 
  
    - Timestamp Converter ë¥¼ ì ìš©í•  field ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
    - í† í”½ì— ìˆëŠ” timestamp column ì„ ê¸°ì…í•©ë‹ˆë‹¤.
  - <var>transforms.TimestampConverter.format</var> : 
  
    - Timestamp Converter ì˜ format ì„ ì„¤ì •í•©ë‹ˆë‹¤.
    - Timestamp ì˜ format ì¸ <code>yyyy-MM-dd HH:mm:ss.S</code> ë¥¼ ê¸°ì…í•©ë‹ˆë‹¤.
  - <var>transforms.TimestampConverter.target.type</var> : 
    
    - Timestamp Converter ë¥¼ ì´ìš©í•˜ì—¬ ë³€í™˜í•œ í›„ì— ì ìš©í•  type ì„ ì„¤ì •í•©ë‹ˆë‹¤.
    - Target DB ì— ë„£ê¸° ìœ„í•´ <code>timestamp</code> ë¥¼ ê¸°ì…í•©ë‹ˆë‹¤.

</CodeDescription>

ì´ì œ Sink Connector ìƒì„±í•˜ëŠ” json íŒŒì¼ì„ curl ì„ ì´ìš©í•˜ì—¬ Connect ì˜ REST API ì— POST method ë¡œ ë³´ëƒ…ë‹ˆë‹¤.

```bash
# terminal-command
curl -X POST http://localhost:8083/connectors -H "Content-Type: application/json" -d @sink_connector.json
```

ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ì¶œë ¥ë©ë‹ˆë‹¤.
```bash
{"name":"postgres-sink-connector","config":{"connector.class":"io.confluent.connect.jdbc.JdbcSinkConnector","connection.url":"jdbc:postgresql://target-postgres-server:5432/targetdatabase","connection.user":"targetuser","connection.password":"targetpassword","table.name.format":"iris_data","topics":"postgres-source-iris_data","auto.create":"false","auto.evolve":"false","tasks.max":"2","name":"postgres-sink-connector"},"tasks":[],"type":"sink"}%
```

### 2.2 ìƒì„± í™•ì¸

ì•„ë˜ì˜ GET method ë¡œ í˜„ì¬ Connector ëª©ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•ì„œ ìƒì„±í•œ Connector ê°€ ì˜ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

```bash
# terminal-command
curl -X GET http://localhost:8083/connectors
```
ìƒì„±ëœ connector ë“¤ì´ ì˜ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

```bash
["postgres-sink-connector","postgres-source-connector"]%
```

ì´ì–´ì„œ `postgres-sink-connector` ì˜ ì •ë³´ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.

```bash
# terminal-command
curl -X GET http://localhost:8083/connectors/postgres-sink-connector
```

ì•„ë˜ì™€ ê°™ì´ ì¶œë ¥ë©ë‹ˆë‹¤.

```bash
{"name":"postgres-sink-connector","config":{"connector.class":"io.confluent.connect.jdbc.JdbcSinkConnector","table.name.format":"iris_data","connection.password":"targetpassword","auto.evolve":"false","connection.user":"targetuser","topics":"postgres-source-iris_data","tasks.max":"2","name":"postgres-sink-connector","auto.create":"false","connection.url":"jdbc:postgresql://target-postgres-server:5432/targetdatabase"},"tasks":[{"connector":"postgres-sink-connector","task":0},{"connector":"postgres-sink-connector","task":1}],"type":"sink"}%
```

### 2.3 ë°ì´í„° í™•ì¸

ë§ˆì§€ë§‰ìœ¼ë¡œ DB ì— ë°ì´í„°ê°€ ì˜ ìŒ“ì—¬ìˆëŠ”ì§€ í™•ì¸í•´ë´…ë‹ˆë‹¤.

1. `psql` ì„ ì´ìš©í•˜ì—¬ Target DB ì— ì ‘ì†í•©ë‹ˆë‹¤.
  ```bash
  # terminal-command
  PGPASSWORD=targetpassword psql -h localhost -p 5433 -U targetuser -d targetdatabase
  psql (14.3, server 14.0 (Debian 14.0-1.pgdg110+1))
  Type "help" for help.
  
  targetdatabase=#
  ```
2. Select ë¬¸ì„ ì‘ì„±í•˜ì—¬ `iris_data` í…Œì´ë¸”ì— ìˆëŠ” ë°ì´í„°ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
  ```sql
  targetdatabase=# SELECT * FROM iris_data LIMIT 100;
  ```
