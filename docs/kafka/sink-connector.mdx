---
sidebar_position: 6
description: ğŸ“Œ DConnect ì— source connector ë¥¼ ë„ì›Œë´…ë‹ˆë‹¤.
---

# 6) Sink Connector
import CodeDescription from '@site/src/components/CodeDescription';
import BrowserWindow from '@site/src/components/BrowserWindow';
import { Chapter, Part } from '@site/src/components/Highlight';
import ArchitectureImage from './img/kafka-15.png';

## ëª©í‘œ

1. Docker-compose ë¥¼ ì´ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ì „ë‹¬ë°›ì„ target postgres server ë¥¼ êµ¬ì¶•í•©ë‹ˆë‹¤.
2. Connect ì— sink connector ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
3. Target postgres server ì—ì„œ ë°ì´í„°ê°€ ì˜ ì „ë‹¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

<details>
<summary>ìŠ¤í™ ëª…ì„¸ì„œ</summary>
<CodeDescription>

### ìŠ¤í™ ëª…ì„¸ì„œ

TBD

</CodeDescription>
</details>

---

<BrowserWindow url="https://github.com/mlops-for-mle/mlops-for-mle/tree/main/ch7">

í•´ë‹¹ íŒŒíŠ¸ì˜ ì „ì²´ ì½”ë“œëŠ” [mlops-for-mle/ch7/](https://github.com/mlops-for-mle/mlops-for-mle/tree/main/ch7) ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```js
ch7
â”œâ”€â”€ Makefile
â”œâ”€â”€ README.md
â”œâ”€â”€ connect.Dockerfile
// highlight-next-line
â”œâ”€â”€ create_table.py
â”œâ”€â”€ kafka-docker-compose.yaml
â”œâ”€â”€ naive-docker-compose.yaml
// highlight-next-line
â”œâ”€â”€ sink_connector.json
â”œâ”€â”€ source_connector.json
// highlight-next-line
â”œâ”€â”€ target-docker-compose.yaml
// highlight-next-line
â””â”€â”€ target.Dockerfile
```

</BrowserWindow>

## 1. Architecture
[ê·¸ë¦¼ 7-15]ì€ ì´ë²ˆ ì‹¤ìŠµì—ì„œ ë‹¤ë£° ì„œë¹„ìŠ¤ë“¤ì˜ ë‹¤ì´ì–´ê·¸ë¨ì…ë‹ˆë‹¤.

<div style={{textAlign: 'center'}}>

<img src={ArchitectureImage}/>
[ê·¸ë¦¼7-15] Kafka System

</div>

- **Target Postgres Server** : sink connector ì—ì„œ ë°ì´í„°ë¥¼ ë°›ì•„ ì €ì¥í•  DB server ì…ë‹ˆë‹¤.
- **Table Creator** : target DB ì— í…Œì´ë¸”ì„ ë§Œë“œëŠ” creator ì…ë‹ˆë‹¤.
- **Sink Connector** : ë°ì´í„°ë¥¼ broker ì˜ topic ì—ì„œ target DB ë¡œ ì „ë‹¬í•  connector ì…ë‹ˆë‹¤.

## 2. Target Postgres Server

### 2.1 Table creator

ì•„ë˜ì˜ ì½”ë“œëŠ” target DB ë¥¼ ë„ìš´ ë‹¤ìŒì— í…Œì´ë¸”ë§Œ ìƒì„±í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ <Part>01. Database</Part> íŒŒíŠ¸ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.

```python  title="create_table.py"
# create_table.py
import psycopg2

def create_table(db_connect):
    create_table_query = """
    CREATE TABLE IF NOT EXISTS iris_data (
        id SERIAL PRIMARY KEY,
        sepal_length float8,
        sepal_width float8,
        petal_length float8,
        petal_width float8,
        target int
    );"""
    print(create_table_query)
    with db_connect.cursor() as cur:
        cur.execute(create_table_query)
        db_connect.commit()

if __name__ == "__main__":
    db_connect = psycopg2.connect(
        user="targetuser",
        password="targetpassword",
        host="target-postgres-server",
        port=5432,
        database="targetdatabase",
    )
    create_table(db_connect)
```

`Dockerfile` ì„ ì´ìš©í•˜ì—¬ ìœ„ì—ì„œ ì‘ì„±í•œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ì´ë¯¸ì§€ë¥¼ ë§Œë“­ë‹ˆë‹¤.

```docker  title=target.Dockerfile
# target.Dockerfile
FROM amd64/python:3.9-slim

WORKDIR /usr/app

RUN pip install -U pip &&\
    pip install psycopg2-binary

COPY create_table.py create_table.py

ENTRYPOINT ["python", "create_table.py"]
```

### 2.2 ì‹¤í–‰

Docker compose ë¥¼ ì´ìš©í•˜ì—¬ target postgres server ì™€ table creator ë¥¼ ë„ì›ë‹ˆë‹¤.

#### 2.2.1 `target-docker-compose.yaml`

ì „ì²´ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

```yaml  title="target-docker-compose.yaml"
# target-docker-compose.yaml
version: "3"

services:
  sink-postgres-server:
    image: postgres:14.0
    container_name: sink-postgres-server
    ports:
      - 5433:5432
    environment:
      POSTGRES_USER: sinkuser
      POSTGRES_PASSWORD: sinkpassword
      POSTGRES_DB: sinkdatabase
    healthcheck:
      test: ["CMD", "pg_isready", "-q", "-U", "sinkuser", "-d", "sinkdatabase"]
      interval: 10s
      timeout: 5s
      retries: 5

  sink-table-creator:
    platform: linux/amd64
    build:
      context: ./docker/sink
      dockerfile: Dockerfile
    container_name: sink-table-creator
    depends_on:
      sink-postgres-server:
        condition: service_healthy

networks:
  default:
    name: ch1_default
    external: true
```

#### 2.2.2 ì‹¤í–‰
`docker compose` ëª…ë ¹ì–´ë¥¼ ì´ìš©í•˜ì—¬ ìœ„ì—ì„œ ì‘ì„±í•œ ì„œë¹„ìŠ¤ë“¤ì„ ë„ì›ë‹ˆë‹¤.

<CodeDescription>

```bash
# terminal-command
docker compose -p ch7-target -f target-docker-compose.yaml up -d
```

- `-p` : project name ì„ `ch7-target` ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
- `-f` :file name ì€ ìœ„ì—ì„œ ì‘ì„±í•œ íŒŒì¼ ì´ë¦„ì¸ `target-docker-compose.yaml`ì„ ì ì–´ì¤ë‹ˆë‹¤.

</CodeDescription>

## 3. Sink Connector

ë‹¤ìŒìœ¼ë¡œ kafka broker ì˜ topic ì—ì„œ target DB ë¡œ ë°ì´í„°ë¥¼ ì „ë‹¬í•˜ëŠ” sink connector ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

### 3.1 ìƒì„±

Sink connector ëŠ” source connector ë¥¼ ë„ìš¸ ë•Œì™€ ë§ˆì°¬ê°€ì§€ë¡œ connect ì˜ REST API ë¥¼ ì´ìš©í•˜ì—¬ ìƒì„±í•©ë‹ˆë‹¤.
ì•„ë˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ sink connector ë¥¼ ë„ìš¸ ìˆ˜ ìˆëŠ” `sink_connector.json` ì„ ìƒì„±í•©ë‹ˆë‹¤.

```bash
# terminal-command
cat <<EOF > sink_connector.json
{
    "name": "postgres-sink-connector",
    "config": {
        "connector.class": "io.confluent.connect.jdbc.JdbcSinkConnector",
        "connection.url": "jdbc:postgresql://target-postgres-server:5432/targetdatabase",
        "connection.user": "targetuser",
        "connection.password": "targetpassword",
        "table.name.format": "iris_data",
        "topics": "postgres-source-iris_data",
        "auto.create": false,
        "auto.evolve": false,
        "tasks.max": 2
    }
}
EOF
```

ìƒì„±í•˜ëŠ” json ì— ëŒ€í•œ ì„¤ëª…ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

<CodeDescription>

```json  title="sink_connector.json"
{
    "name": "postgres-sink-connector",
    "config": {
        "connector.class": "io.confluent.connect.jdbc.JdbcSinkConnector",
        "connection.url": "jdbc:postgresql://target-postgres-server:5432/targetdatabase",
        "connection.user": "targetuser",
        "connection.password": "targetpassword",
        "table.name.format": "iris_data",
        "topics": "postgres-source-iris_data",
        "auto.create": false,
        "auto.evolve": false,
        "tasks.max": 2
    }
}
```

- name :
  - connector ì˜ ì´ë¦„ì„ ì •í•©ë‹ˆë‹¤.
  - ì´ë²ˆ ì±•í„°ì—ì„œëŠ” `postgres-sink-connector` ë¥¼ ì‚¬ìš©í•˜ê² ìŠµë‹ˆë‹¤.
- config :
    - `connector.class` : 
      - connector ë¥¼ ìƒì„±í•˜ê¸° ìœ„í•œ class ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
      - ì´ë²ˆ ì±•í„°ì—ì„œëŠ” JDBC source connector ë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— `io.confluent.connect.jdbc.JdbcSinkConnector` ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.
    - `connection.url` : 
      - DB ì— ì ‘ê·¼í•˜ê¸° ìœ„í•œ ì£¼ì†Œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
      - ì´ë²ˆ ì±•í„°ì—ì„œëŠ” ì•ì„œ ë„ì›Œë‘ì—ˆë˜ target-postgres-server ì˜ URL ì¸ `jdbc:postgresql://target-postgres-server:5432/targetdatabase` ì„ ì…ë ¥í•©ë‹ˆë‹¤.
    - `connection.user` : 
      - DB ì— ì ‘ì†í•˜ê¸° ìœ„í•œ user name ì„ ì„¤ì •í•©ë‹ˆë‹¤.
      - ì´ë²ˆ ì±•í„°ì—ì„œëŠ” `targetuser` ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.
    - `connection.password` : 
      - DB ì— ì ‘ì†í•˜ê¸° ìœ„í•œ password ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
      - ì´ë²ˆ ì±•í„°ì—ì„œëŠ” `targetpassword` ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.
    - `table.name.format` : 
      - target í…Œì´ë¸”ì˜ ì´ë¦„ì— ëŒ€í•œ format ì„ ì„¤ì •í•©ë‹ˆë‹¤.
      - ì´ë²ˆ ì±•í„°ì—ì„œëŠ” `iris_data` ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
    - `topics` : 
      - sink connector ê°€ broker ì— ìˆëŠ” topic ë“¤ ì¤‘ì— ì–´ë–¤ topic ì— ìˆëŠ” ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ì§€ ì„¤ì •í•©ë‹ˆë‹¤.
      - ì´ë²ˆ ì±•í„°ì—ì„œëŠ” `postgres-source-iris_data` ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.
    - `auto.create` : 
      - í…Œì´ë¸”ì„ ìë™ìœ¼ë¡œ ìƒì„±í•  ì§€ì˜ ì—¬ë¶€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. ì´ë¯¸ í…Œì´ë¸”ì„ ìƒì„±í–ˆê¸° ë•Œë¬¸ì— `false` ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
    - `auto.evolve` : 
      - í…Œì´ë¸”ì— ìë™ìœ¼ë¡œ column ì„ ìƒì„±í•  ì§€ì˜ ì—¬ë¶€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. ì´ë¯¸ í…Œì´ë¸”ì˜ schema ë„ ìƒì„±í–ˆê¸° ë•Œë¬¸ì— `false` ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
    - `tasks.max` : 
      - connector ì—ì„œ task ì˜ ìˆ˜ë¥¼ ì–¼ë§ˆë‚˜ ê°€ì ¸ê°ˆ ì§€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
      - ì´ë²ˆ ì±•í„°ì—ì„œëŠ” 2ë¡œ ì„¤ì •í•´ì£¼ê² ìŠµë‹ˆë‹¤.

</CodeDescription>

ì´ì œ ì‘ì„±ëœ json íŒŒì¼ì„ curl ì„ ì´ìš©í•˜ì—¬ connect ì˜ REST API ì— POST method ë¡œ ë³´ëƒ…ë‹ˆë‹¤.

```bash
# terminal-command
curl -X POST http://localhost:8083/connectors -H "Content-Type: application/json" -d @sink_connector.json
```

ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ì¶œë ¥ë©ë‹ˆë‹¤.
```bash
{"name":"postgres-sink-connector","config":{"connector.class":"io.confluent.connect.jdbc.JdbcSinkConnector","connection.url":"jdbc:postgresql://target-postgres-server:5432/targetdatabase","connection.user":"targetuser","connection.password":"targetpassword","table.name.format":"iris_data","topics":"postgres-source-iris_data","auto.create":"false","auto.evolve":"false","tasks.max":"2","name":"postgres-sink-connector"},"tasks":[],"type":"sink"}%
```

### 2.2 ìƒì„± í™•ì¸

ì•„ë˜ì˜ GET method ë¡œ í˜„ì¬ connector ëª©ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
# terminal-command
curl -X GET http://localhost:8083/connectors
```
ì•ì„œ ìƒì„±í•œ connector ë“¤ì´ ì˜ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

```bash
["postgres-sink-connector","postgres-source-connector"]%
```

ì´ì–´ì„œ `postgres-sink-connector` ì˜ ì¶”ê°€ ì •ë³´ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.

```bash
# terminal-command
curl -X GET http://localhost:8083/connectors/postgres-sink-connector
```

ì•„ë˜ì™€ ê°™ì´ ì¶œë ¥ë©ë‹ˆë‹¤.

```bash
{"name":"postgres-sink-connector","config":{"connector.class":"io.confluent.connect.jdbc.JdbcSinkConnector","table.name.format":"iris_data","connection.password":"targetpassword","auto.evolve":"false","connection.user":"targetuser","topics":"postgres-source-iris_data","tasks.max":"2","name":"postgres-sink-connector","auto.create":"false","connection.url":"jdbc:postgresql://target-postgres-server:5432/targetdatabase"},"tasks":[{"connector":"postgres-sink-connector","task":0},{"connector":"postgres-sink-connector","task":1}],"type":"sink"}%
```

### 2.2 ë°ì´í„° í™•ì¸

ë§ˆì§€ë§‰ìœ¼ë¡œ DB ì— ë°ì´í„°ê°€ ì˜ ìŒ“ì—¬ìˆëŠ”ì§€ í™•ì¸í•´ë´…ë‹ˆë‹¤.

1. ì•„ë˜ì˜ ëª…ë ¹ì–´ë¥¼ ì´ìš©í•˜ì—¬ target DB ì— ì ‘ì†í•©ë‹ˆë‹¤.
  ```bash
  # terminal-command
  PGPASSWORD=targetpassword psql -h localhost -p 5433 -U targetuser -d targetdatabase
  ```
2.  Select ë¬¸ì„ ì‘ì„±í•˜ì—¬ ë°ì´í„°ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
  ```sql
  targetdatabase=# SELECT * FROM iris_data LIMIT 100;
  ```
